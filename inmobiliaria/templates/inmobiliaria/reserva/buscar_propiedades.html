{% extends 'inmobiliaria/base.html' %}
{% load bootstrap4 %}
{% load custom_filters %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar Propiedades</title>
    
    <style>
    .property-card {
        transition: background-color 0.3s ease;
    }
    .property-card.card-confirmada {
        background-color: #ffcccc !important;
        border-color: #ff8888 !important;
    }
    #propiedadesTable tbody tr.table-active {
        background-color: #007bff;
        color: white;
    }

    .modal {
        z-index: 1050 !important;
    }
    .modal-backdrop {
        z-index: 1040 !important;
    }
    .select2-container {
        z-index: 1051 !important;
    }

    </style>
</head>

{% block title %}Buscar Propiedades{% endblock %}

{% block content %}
<h1>Buscar Propiedades</h1>

<div class="row">
    <div class="col-md-8">
        <!-- Formulario para reservas por día -->
        <form method="post" id="buscar-propiedades-form-dia">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-3">
                    {% bootstrap_field form.fecha_inicio %}
                </div>
                <div class="col-md-3">
                    {% bootstrap_field form.fecha_fin %}
                </div>
                <div class="col-md-3">
                    {% bootstrap_field form.ambientes %}
                </div>
            </div>

            <button type="button" class="btn btn-secondary" id="toggle-filtros" onclick="mostrarOcultarFiltros()">Mostrar Filtros</button>
            <button type="button" class="btn btn-warning" id="reset-filtros" onclick="resetearFiltros()" style="display: none;">Resetear Filtros</button>

            <div id="filtros-completos" style="display: none;">
                <div class="row">
                    <div class="col-md-4">
                        {% bootstrap_field form.tipo_inmueble %}
                    </div>
                    <div class="col-md-4">
                        {% bootstrap_field form.vista %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        {% bootstrap_field form.precio_min %}
                    </div>
                    <div class="col-md-3">
                        {% bootstrap_field form.precio_max %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        {% bootstrap_field form.valoracion %}
                    </div>
                </div>
                <h4>Características adicionales</h4>
                <div class="row">
                    <div class="col-md-3">
                        {% bootstrap_field form.amoblado %}
                        {% bootstrap_field form.cochera %}
                        {% bootstrap_field form.tv_smart %}
                    </div>
                    <div class="col-md-3">
                        {% bootstrap_field form.wifi %}
                        {% bootstrap_field form.dependencia %}
                        {% bootstrap_field form.patio %}
                    </div>
                    <div class="col-md-3">
                        {% bootstrap_field form.parrilla %}
                        {% bootstrap_field form.piscina %}
                        {% bootstrap_field form.reciclado %}
                    </div>
                    <div class="col-md-3">
                        {% bootstrap_field form.a_estrenar %}
                        {% bootstrap_field form.terraza %}
                        {% bootstrap_field form.balcon %}
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <button type="submit" class="btn btn-primary">Buscar</button>
                </div>
            </div>
        </form>

        {% if propiedades_disponibles %}
        <h3 class="text-center mt-4">Propiedades Disponibles del {{ fecha_inicio }} al {{ fecha_fin }}</h3>
        <table id="propiedadesTable" class="table table-hover">
            <thead>
                <tr>
                    <th>ID Propiedad</th>
                    <th>Disponibilidad más cercana</th>
                    <th>Dirección</th>
                    <th>Piso</th>
                    <th>Dpto</th>
                    <th>Propietario</th>
                    <th>Precio</th>
                </tr>
            </thead>
            <tbody>
                {% for propiedad in propiedades_disponibles %}
                {% if propiedad.estado_reserva == 'confirmada_no_pagada' %}
                <tr data-index="{{ forloop.counter0 }}" onclick="seleccionarPropiedad( '{{total_dias}}','{{ propiedad.direccion|escapejs }}', '{{ propiedad.propietario.nombre|escapejs }}', '{{ propiedad.disponibilidad }}','{{ propiedad.precio_total_reserva |format_price  }}','{{ propiedad.id }}',  '{{ fecha_inicio }}', '{{ fecha_fin }}', '{{ propiedad.estado_reserva }}','{{ propiedad.reserva.id }}',)">
                   <td style="color: red;">{{ propiedad.id }}</td>
                   <td style="color: red;">
                    Reservado del {{propiedad.disponibilidad_inicio }} al {{propiedad.disponibilidad_fin }}
                    </td>
                    <td style="color: red;">{{ propiedad.direccion }}</td>
                    <td style="color: red;">{{ propiedad.piso }}</td>
                    <td style="color: red;"> {{propiedad.dpto }}</td>
                    <td style="color: red;">{{ propiedad.propietario.nombre }}</td>
                    <td style="color: red;">{{ propiedad.precio_total_reserva }}</td>
                    
                </tr>
               
                {% else %}
                <tr data-index="{{ forloop.counter0 }}" onclick="seleccionarPropiedad( '{{total_dias}}','{{ propiedad.direccion|escapejs }}', '{{ propiedad.propietario.nombre|escapejs }}', '{{ propiedad.disponibilidad }}','{{ propiedad.precio_total_reserva |format_price  }}','{{ propiedad.id }}',  '{{ fecha_inicio }}', '{{ fecha_fin }}', '{{ propiedad.estado_reserva }}',)">
                    <td>{{ propiedad.id }}</td>
                    <td>
                        
                            {{propiedad.disponibilidad_inicio | date:"d/m/Y"}} al {{propiedad.disponibilidad_fin | date:"d/m/Y"}}
                           
                    </td>
                    <td>{{ propiedad.direccion }}</td>
                    <td>{{ propiedad.piso }}</td>
                    <td>{{ propiedad.dpto }}</td>
                    <td>{{ propiedad.propietario.nombre }}</td>
                    <td>{{ propiedad.precio_total_reserva|format_price }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <div class="alert alert-warning text-center mt-4">
                No hay propiedades disponibles para las fechas seleccionadas.
            </div>
            {% if alerta_sin_precio %}
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Atención',
                        text: 'Hay propiedades sin precio asignado',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#3085d6',
                        timer: 5000,
                        timerProgressBar: true
                    });
                });
            </script>
            {% endif %}
        {% endif %}
    </div>

<!-- Tarjeta de propiedad seleccionada -->
<div class="col-md-4" class="card property-card" id="propertyCard">
    <div  style="position: sticky; top: 20px;">
        <div class="card-header">
            Propiedad Seleccionada
        </div>
        <div class="card-body">
            <h5 class="card-title" id="cardPropiedad">Ficha: </h5>
            <h5 class="card-title" id="cardDireccion">Dirección: </h5>
            <p class="card-text" id="cardPropietario">Propietario: </p>
            <p class="card-text" id="cardDisponibilidad">Disponibilidad: </p>
            <p class="card-text" id="cardPrecio">Precio: </p>
        </div>
        <div class="card-footer" id="cardButtons">
            <!-- Los botones se insertarán aquí dinámicamente -->
        </div>
    </div>
</div>



<!-- Modal Confirmar Reserva -->
<div class="modal fade" id="modalConfirmarReserva" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Confirmar Reserva</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>Propiedad:</strong> <span id="propiedadDireccion"></span></p>
                <p><strong>Fecha de inicio:</strong> <span id="fechaInicio"></span></p>
                <p><strong>Fecha de fin:</strong> <span id="fechaFin"></span></p>
                <p><strong>Total de días:</strong> <span id="totalDias"></span></p>
                <p><strong>Precio total:</strong> <span id="precioTotalSuperior"></span></p>

                <div>
                    <label for="vendedor_id">ID del Vendedor:</label>
                    <input type="number" id="vendedor_id" name="vendedor" >
                    <p><strong>Nombre del Vendedor:</strong> <span id="vendedor_nombre"></span></p>
                </div>
                <!-- Dentro del modal de Confirmar Reserva -->
                <div class="form-group">
                    <label for="inquilino">Buscar Inquilino:</label>
                    <select id="inquilino" name="inquilino" class="form-control" style="width: 100%;">
                        <option value="">Seleccione un inquilino</option>
                        {% for inquilino in inquilinos %}
                        <option value="{{ inquilino.id }}">{{ inquilino.nombre }} {{ inquilino.apellido }} - {{ inquilino.dni }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="nuevo-inquilino-fields">
                    <!-- Botón para abrir el modal de crear inquilino -->
                    <button id="abrir-modal-inquilino-btn" type="button" class="btn btn-success" data-toggle="modal" data-target="#modal-inquilino">Crear Nuevo Inquilino</button>
                </div>
                       
                <div id="modal-inquilino" class="modal fade" tabindex="-1" role="dialog">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalInquilinoLabel">Agregar Nuevo Inquilino</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="form-nuevo-inquilino" method="post">
                                    {% csrf_token %}
                                    {{ inquilino_form.as_p }}
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                                <button type="button" id="guardar-inquilino-btn" data-dismiss="modal" class="btn btn-primary">Guardar Inquilino</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="precio_total">Precio Total:</label>
                    <span id="precio_total_display">{{ precio_total }}</span>
                    <button type="button" id="editar_precio_btn" class="btn btn-link">Editar</button>
                    <input type="number" step="0.01" class="form-control" id="precio_total" name="precio_total" style="display: none;" required>
                    <button type="button" id="guardar_precio_btn" class="btn btn-link" style="display: none;">Guardar</button>
                    <button type="button" id="cancelar_precio_btn" class="btn btn-link" style="display: none;">Cancelar</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close" data-dismiss="modal" aria-label="Close">Cerrar</button>
                <form id="confirmar-reserva-form" method="post" action="{% url 'inmobiliaria:confirmar_reserva' %}">
                    {% csrf_token %}
                    <input type="hidden" name="propiedad_id" id="modalPropiedadId">
                    <input type="hidden" name="fecha_inicio" id="modalFechaInicio">
                    <input type="hidden" name="fecha_fin" id="modalFechaFin">
                    <input type="hidden" name="vendedor_id" id="modalVendedorId">
                    <input type="hidden" name="inquilino_id" id="modalInquilinoId">
                    <input type="hidden" name="precio_total" id="modalPrecioTotal"  >
                    <button type="submit" class="btn btn-primary" id="confirmar-reserva-btn">Confirmar Reserva</button>
                </form>
            </div>
        </div>
    </div>
</div>


  
<div id="modal-inquilino" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalInquilinoLabel">Agregar Nuevo Inquilino</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-nuevo-inquilino" method="post">
                    {% csrf_token %}
                    {{ inquilino_form.as_p }}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" id="guardar-inquilino-btn" data-dismiss="modal" class="btn btn-primary">Guardar Inquilino</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal de Autenticación del Vendedor -->
<div class="modal fade" id="modalAutenticacionVendedor" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Autenticación del Vendedor</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formAutenticacionVendedor">
                    <div class="form-group">
                        <label for="usuarioVendedor">Usuario:</label>
                        <input type="text" class="form-control" id="usuarioVendedor" required>
                    </div>
                    <div class="form-group">
                        <label for="contrasenaVendedor">Contraseña:</label>
                        <input type="password" class="form-control" id="contrasenaVendedor" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancelarReservaBtnA">Cancelar</button>

                <button type="button" class="btn btn-primary" onclick="autenticarYFinalizar()">Autenticar y Finalizar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPrecios" tabindex="-1" role="dialog" aria-labelledby="modalPreciosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPreciosLabel">Precios de la Propiedad</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="preciosModalBody">
                <!-- Contenido del modal -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close" data-dismiss="modal" aria-label="Close">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modales para ver detalles de la propiedad -->
{% for propiedad in propiedades_disponibles %}
<div class="modal fade" id="modalDetalles{{ propiedad.id }}" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles de la Propiedad</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Carrusel de imágenes -->
                {% if propiedad.imagenes.all %}
                    <div id="carousel{{ propiedad.id }}" class="carousel slide mb-4" data-ride="carousel">
                        <div class="carousel-inner">
                            {% for imagen in propiedad.imagenes.all %}
                                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                    <img src="{{ imagen.imagen.url }}" class="d-block w-100" alt="Imagen de la propiedad" style="height: 300px; object-fit: cover;">
                                </div>
                            {% endfor %}
                        </div>
                        {% if propiedad.imagenes.all|length > 1 %}
                            <a class="carousel-control-prev" href="#carousel{{ propiedad.id }}" role="button" data-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="sr-only">Anterior</span>
                            </a>
                            <a class="carousel-control-next" href="#carousel{{ propiedad.id }}" role="button" data-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="sr-only">Siguiente</span>
                            </a>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="alert alert-info">No hay imágenes disponibles para esta propiedad.</div>
                {% endif %}

                <!-- Detalles de la propiedad -->
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Dirección:</strong> {{ propiedad.direccion }}</p>
                        <p><strong>Piso:</strong> {{ propiedad.piso }}</p>
                        <p><strong>Departamento:</strong> {{ propiedad.dpto }}</p>
                        <p><strong>Tipo de Inmueble:</strong> {{ propiedad.tipo_inmueble }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Ambientes:</strong> {{ propiedad.ambientes }}</p>
                        <p><strong>Valoración:</strong> {{ propiedad.valoracion }}</p>
                        <p><strong>Características:</strong> {{ propiedad.caracteristicas }}</p>
                        <p><strong>Precio Final:</strong> {{ propiedad.precio_total_reserva }}</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Precios -->

{% endfor %}



<script>
    // Añade esto al principio de tus scripts
    const URLS = {
        obtenerPrecios: "{% url 'inmobiliaria:obtener_precios_propiedad' %}"
    };
</script>
<!-- Incluir jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Incluir Bootstrap JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<script>
    function formatPrice(value) {
    return value.toLocaleString('es-ES', { minimumFractionDigits: 0 });
}
$('#modalPrecios .close').click(function () {
    $('#modalPrecios').modal('hide');
});
    // Función para mostrar y ocultar filtros
    function mostrarOcultarFiltros() {
        const filtros = document.getElementById("filtros-completos");
        const resetBoton = document.getElementById("reset-filtros");
        
        if (filtros.style.display === "none") {
            filtros.style.display = "block";
            resetBoton.style.display = "inline-block"; // Mostrar el botn de reset
        } else {
            filtros.style.display = "none";
            resetBoton.style.display = "none"; // Ocultar el botón de reset
        }
    }

    // Función para restablecer filtros
    function resetearFiltros() {
        document.getElementById("buscar-propiedades-form-dia").reset(); // Reiniciar el formulario
        mostrarOcultarFiltros(); // Ocultar los filtros
    }
    let selectedRowIndex = -1;
    function seleccionarPropiedad(total_dias, direccion, propietario, disponibilidad, precio, id, fechaInicio, fechaFin, estadoReserva, reserva_id) {
        console.log('El estado de la reserva es:', estadoReserva);
        console.log('El ID de la propiedad es:', id);
        
        window.fechaInicioSeleccionada = fechaInicio.trim();
        window.fechaFinSeleccionada = fechaFin.trim();
        window.total_dias = total_dias;

        const row = event.currentTarget;
        const rows = document.querySelectorAll('#propiedadesTable tbody tr');
        rows.forEach(r => r.classList.remove('table-active'));
        row.classList.add('table-active');
        
        // Actualizar la tarjeta de propiedad
        document.getElementById("cardDireccion").innerText = "Dirección: " + direccion;
        document.getElementById("cardPropietario").innerText = "Propietario: " + propietario;
        document.getElementById("cardDisponibilidad").innerText = "Disponibilidad: " + disponibilidad;
        document.getElementById("cardPrecio").innerText = "Precio: " + formatPrice(precio);
        document.getElementById("cardPropiedad").innerText = "Ficha: " + id;

        const propertyCard = document.getElementById("propertyCard");
        const cardButtons = document.getElementById("cardButtons");

        // Limpiar botones existentes
        cardButtons.innerHTML = '';

        // Remover clases previas
        propertyCard.classList.remove('card-confirmada');

        // Verificar el estado de la reserva y mostrar los botones correspondientes
        if (estadoReserva === 'confirmada_no_pagada') {
            propertyCard.classList.add('card-confirmada');
            cardButtons.innerHTML = `
                <button type="button" class="btn btn-sm btn-success" onclick="mostrarModalAutenticacion('${reserva_id}')">Operacion</button>
                <button type="button" class="btn btn-info" data-toggle="modal" data-target="#modalDetalles${id}">Ver</button>
                <button type="button" class="btn btn-warning" onclick="mostrarPrecios(${id})">Ver Precios</button>
            `;
        } else {
            cardButtons.innerHTML = `
                <button type="button" class="btn btn-primary" onclick="confirmarReserva()">Reservar</button>
                <button type="button" class="btn btn-info" data-toggle="modal" data-target="#modalDetalles${id}">Ver</button>
                <button type="button" class="btn btn-warning" onclick="mostrarPrecios(${id})">Ver Precios</button>
            `;
        }

    // Forzar un repintado del DOM
    void propertyCard.offsetWidth;

    // Guarda las fechas para usarlas más tarde
    window.fechaInicioSeleccionada = fechaInicio;
    window.fechaFinSeleccionada = fechaFin;
}

function mostrarPrecios(propiedad_id) {
    console.log('Mostrando precios para propiedad:', propiedad_id);
    
    const modal = $('#modalPrecios');
    if (modal.length === 0) {
        console.error('Modal no encontrado');
        return;
    }
    
    modal.modal('show');
    
    $('#preciosModalBody').html(`
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="sr-only">Cargando...</span>
            </div>
        </div>
    `);
    
    $.ajax({
        url: "{% url 'inmobiliaria:obtener_precios_propiedad' %}",
        data: { 'propiedad_id': propiedad_id },
        method: 'GET',
        success: function(response) {
            console.log('Respuesta:', response);
            
            if (response.precios && response.precios.length > 0) {
                let tableContent = `
                    <table class="table table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th>Quincena</th>
                                <th>Precio por Día</th>
                                <th>Precio Total</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                response.precios.forEach(function(precio) {
                    tableContent += `
                        <tr>
                            <td>${precio.tipo_precio}</td>
                            <td>$${formatPrice(precio.precio_por_dia)}</td>
                            <td>$${formatPrice(precio.precio_total)}</td>
                        </tr>
                    `;
                });
                
                tableContent += `
                        </tbody>
                    </table>
                `;
                
                $('#preciosModalBody').html(tableContent);
            } else {
                $('#preciosModalBody').html(`
                    <div class="alert alert-warning">
                        No hay precios registrados para esta propiedad.
                    </div>
                `);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            $('#preciosModalBody').html(`
                <div class="alert alert-danger">
                    Error al cargar los precios: ${error}
                </div>
            `);
        }
    });
}



function confirmarReserva() {
    const ficha = document.getElementById("cardPropiedad").innerText.split(": ")[1]; // Extraer el ID
    const direccion = document.getElementById("cardDireccion").innerText.split(": ")[1];
    const propietario = document.getElementById("cardPropietario").innerText.split(": ")[1];
    const disponibilidad = document.getElementById("cardDisponibilidad").innerText.split(": ")[1];
    const precio = document.getElementById("cardPrecio").innerText.split(": ")[1];

    const fechaInicio = window.fechaInicioSeleccionada;
    console.log("hola soy la fecha de inicio",window.fechaInicioSeleccionada);
    const fechaFin = window.fechaFinSeleccionada;
    const totalDias = window.total_dias;
    console.log("hola soy el total de diassssss",totalDias); 

    // Verifica si los valores se obtienen correctamente
    console.log("ID Propiedad:", ficha);
    console.log("Dirección:", direccion);
    console.log("Propietario:", propietario);
    console.log("Disponibilidad:", disponibilidad);
    console.log("Precio por Día:", precio);
    console.log("Fecha Inicio:", fechaInicio);
    console.log("Fecha Fin:", fechaFin);
    

    // Lógica de confirmación
    Swal.fire({
        title: '¿Está seguro?',
        text: "¿Desea reservar esta propiedad?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, reservar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            mostrarModalAutenticacionParaReserva(ficha, direccion, propietario, disponibilidad, precio, fechaInicio, fechaFin, totalDias);
        }
    });
}
function formatearFecha(fecha) {
    const d = new Date(fecha);
    const dia = d.getDate().toString().padStart(2, '0');
    const mes = (d.getMonth() + 1).toString().padStart(2, '0'); // Los meses en JavaScript van de 0 a 11
    const anio = d.getFullYear();
    return `${dia}/${mes}/${anio}`;
}
function mostrarModalReserva(ficha, direccion, propietario, disponibilidad, precio, fechaInicio, fechaFin, totalDias) {
    document.getElementById("propiedadDireccion").textContent = direccion;
    document.getElementById("fechaInicio").textContent = formatearFecha(fechaInicio);;
    document.getElementById('fechaFin').textContent = formatearFecha(fechaFin);
    
    document.getElementById("fechaInicio").textContent = fechaInicio;
    document.getElementById("fechaFin").textContent = fechaFin;
   
    console.log("hola soy la fecha de inicio",fechaInicio);
    console.log("hola soy la fecha de fin",fechaFin);
    console.log("hola soy la cantidad de dias",totalDias);

    // Asegúrate de que las fechas estén correctamente formateadas antes de crear los objetos Date
    

    
    // Calcula el total de días
   

    // Muestra el total de días en la consola
    console.log("Total de días:", totalDias);

    document.getElementById("totalDias").textContent = `${totalDias} días`;
    document.getElementById("precioTotalSuperior").textContent = precio;


 
    document.getElementById("precioTotalSuperior").textContent = precio;
    document.getElementById("precio_total_display").textContent = precio;
    document.getElementById("precio_total").value = precio;

    document.getElementById("modalPropiedadId").value = ficha;
    document.getElementById("modalFechaInicio").value = fechaInicio;
    document.getElementById("modalFechaFin").value = fechaFin;
    document.getElementById("modalPrecioTotal").value = precio;

    const precioTotalDisplay = document.getElementById('precio_total_display');
    const precioTotalInput = document.getElementById('precio_total');
    const editarPrecioBtn = document.getElementById('editar_precio_btn');
    const guardarPrecioBtn = document.getElementById('guardar_precio_btn');
    const cancelarPrecioBtn = document.getElementById('cancelar_precio_btn');

    precioTotalDisplay.textContent = precio;
    precioTotalInput.value = precio;
    

    $('#modalConfirmarReserva').modal('show');
}
function cancelarReserva(reservaId) {
        // Aquí puedes implementar la lógica para cancelar la reserva
        console.log("Reserva cancelada: " + reservaId);
    }

    // Validación del formulario antes de enviarlo
    document.getElementById("buscar-propiedades-form-dia").addEventListener("submit", function(event) {
        const fechaInicio = new Date(document.getElementById("id_fecha_inicio").value);
        const fechaFin = new Date(document.getElementById("id_fecha_fin").value);

        if (fechaInicio >= fechaFin) {
            alert("La fecha de inicio debe ser anterior a la fecha de fin.");
            event.preventDefault(); // Prevenir el envío del formulario
        }
    });
    
   document.getElementById('confirmar-reserva-form').addEventListener('submit', function(event) {
    // Obtener los valores de vendedor e inquilino seleccionados
    const vendedorSeleccionado = document.getElementById('vendedor').value;
    const clienteSeleccionado = document.getElementById('inquilino').value;

    // Pasar los valores seleccionados a los campos ocultos del formulario
    document.getElementById('modalVendedor').value = vendedorSeleccionado;
    document.getElementById('modalInquilino').value = clienteSeleccionado;
    const precio = document.getElementById('precio_total').value;
    document.getElementById('modalPrecioTotal').value = precio;
    console.log("hola soy el precio total ",precio);
 
});
 document.addEventListener('keydown', function(event) {
    const rows = document.querySelectorAll('#propiedadesTable tbody tr');
    let newIndex = selectedRowIndex;

    if (event.key === 'ArrowUp') {
        newIndex = Math.max(0, selectedRowIndex - 1);
    } else if (event.key === 'ArrowDown') {
        newIndex = Math.min(rows.length - 1, selectedRowIndex + 1);
    } else {
        return; // Si no es una tecla de flecha, no hacemos nada
    }

    if (newIndex !== selectedRowIndex) {
        event.preventDefault(); // Prevenir el desplazamiento de la página
        const newRow = rows[newIndex];
        newRow.click(); // Simular un clic en la nueva fila
        newRow.scrollIntoView({behavior: 'smooth', block: 'nearest'}); // Asegurar que la fila sea visible
    }
});
function mostrarModalAutenticacion(reservaId) {
    window.reservaIdActual = reservaId; // Guardar el ID de la reserva para usarlo después
    $('#modalAutenticacionVendedor').modal('show');
}

function autenticarYFinalizar() {
    var usuario = document.getElementById('usuarioVendedor').value;
    var contrasena = document.getElementById('contrasenaVendedor').value;
    var reservaId = window.reservaIdActual;
    console.log("hola soy el reservaId",reservaId);
     // Usar el ID guardado

    // Enviar los datos a través de AJAX
    $.ajax({
        url: '{% url "inmobiliaria:autenticacion_vendedor" %}',
        type: 'POST',
        data: {
            'username': usuario,
            'password': contrasena,
            'reserva_id': reservaId,
            'csrfmiddlewaretoken': '{{ csrf_token }}',
        },
        success: function(response) {
            if (response.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Autenticación exitosa',
                    text: 'Finalizando operación...',
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    // Aqu puedes poner el código que se ejecuta después de que se cierre la alerta
                    window.location.href = '{% url "inmobiliaria:finalizar_reserva" 0 %}'.replace('0', response.reserva_id);
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error de autenticación',
                    text: 'Credenciales incorrectas, por favor intente de nuevo.'
                });
            }
        },
        error: function(xhr, status, error) {
            Swal.fire({
                icon: 'error',
                title: 'Error del servidor',
                text: 'Ocurrió un error en el servidor. Por favor, intente de nuevo.'
            });
        }
    });
}
// Seleccionar la primera fila al cargar la página
window.addEventListener('load', function() {
    const firstRow = document.querySelector('#propiedadesTable tbody tr');
    if (firstRow) {
        firstRow.click();
    }
});
function mostrarModalAutenticacionParaReserva(ficha, direccion, propietario, disponibilidad, precio, fechaInicio, fechaFin, totalDias) {
    // Guardamos los datos de la reserva en variables globales
    window.datosReserva = {ficha, direccion, propietario, disponibilidad, precio, fechaInicio, fechaFin,totalDias};
    console.log("hola soy el window.datosReserva",window.datosReserva);
    // Mostramos el modal de autenticación
    $('#modalAutenticacionVendedor').modal('show');
    
    // Cambiamos el texto del botón de autenticación
    document.querySelector('#modalAutenticacionVendedor .btn-primary').textContent = 'Autenticar y Reservar';
    
    // Cambiamos la función que se ejecuta al hacer clic en el botón
    document.querySelector('#modalAutenticacionVendedor .btn-primary').onclick = autenticarYReservar;
}
function autenticarYReservar() {
    var usuario = document.getElementById('usuarioVendedor').value;
    var contrasena = document.getElementById('contrasenaVendedor').value;
    var reservaId = window.reservaIdActual;

    // Enviar los datos a través de AJAX     s
    $.ajax({
        url: '{% url "inmobiliaria:autenticacion_vendedor" %}',
        type: 'POST',
        data: {
            'username': usuario,
            'password': contrasena,
            'csrfmiddlewaretoken': '{{ csrf_token }}',
        },
        success: function(response) {
            if (response.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Autenticación exitosa',
                    text: 'Procediendo con la reserva...',
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    $('#modalAutenticacionVendedor').modal('hide');
                    // Si la autenticación es exitosa, mostramos el modal de reserva
                    mostrarModalReserva(
                        window.datosReserva.ficha,
                        window.datosReserva.direccion,
                        window.datosReserva.propietario,
                        window.datosReserva.disponibilidad,
                        window.datosReserva.precio,
                        window.datosReserva.fechaInicio,
                        window.datosReserva.fechaFin,
                        window.datosReserva.totalDias
                    );
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error de autenticación',
                    text: 'Credenciales incorrectas, por favor intente de nuevo.'
                });
            }
        },
        error: function(xhr, status, error) {
            Swal.fire({
                icon: 'error',
                title: 'Error del servidor',
                text: 'Ocurrió un error en el servidor. Por favor, intente de nuevo.'
            });
        }
    });
}

</script>
<script>
    document.getElementById('agregarClienteBtn').addEventListener('click', function() {
        var nuevoClienteContainer = document.getElementById('nuevoClienteContainer');
        if (nuevoClienteContainer.style.display === "none" || nuevoClienteContainer.style.display === "") {
            nuevoClienteContainer.style.display = "block";
        } else {
            nuevoClienteContainer.style.display = "none";
        }
    });

  
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<script type="text/javascript">
    // Configurar CSRF para todas las solicitudes AJAX
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- {% if messages %}
<script>
    {% for message in messages %}
        Swal.fire({
            icon: '{% if message.tags == "error" %}error{% else %}{{ message.tags }}{% endif %}',
            title: '{{ message.tags|title }}',
            text: '{{ message|safe }}',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,ƒ
            timer: 3000
        });
    {% endfor %}
</script>
{% endif %} -->
<script>
    // Cuando cambia el vendedor
    $('#vendedor_id').on('change', function() {
        $('#modalVendedorId').val($(this).val());
    });

    // Cuando cambia el inquilino
    $('#inquilino').on('change', function() {
        $('#modalInquilinoId').val($(this).val());
    });

    // Cuando se actualiza el precio
    $('#precio_total').on('change', function() {
        $('#modalPrecioTotal').val($(this).val());
    });
</script>
<!-- ... mantener el modal como está ... -->

<script>
    $(document).ready(function() {
        // Manejar el click en el botón de guardar inquilino
        $('#guardar-inquilino-btn').click(function(e) {
            e.preventDefault();
            
            // Obtener los datos del formulario
            const formData = new FormData($('#form-nuevo-inquilino')[0]);
            
            // Agregar el token CSRF
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            // Realizar la petición AJAX
            $.ajax({
                url: '{% url "inmobiliaria:crear_inquilino_ajax" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        // Crear nueva opción para el select
                        const newOption = new Option(
                            `${response.nombre} ${response.apellido} - ${response.dni}`,
                            response.id,
                            true,
                            true
                        );
                        
                        // Agregar la opción al select y seleccionarla
                        $('#inquilino').append(newOption).trigger('change');
                        
                        // Actualizar el campo oculto
                        $('#modalInquilinoId').val(response.id);
                        
                        // Cerrar el modal
                        $('#modal-inquilino').modal('hide');
                        
                        // Limpiar el formulario
                        $('#form-nuevo-inquilino')[0].reset();
                        
                        // Mostrar mensaje de éxito
                        Swal.fire({
                            icon: 'success',
                            title: 'Éxito',
                            text: 'Inquilino creado correctamente',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    } else {
                        // Mostrar errores si los hay
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.errors || 'Error al crear el inquilino',
                            timer: 3000
                        });
                    }
                },
                error: function(xhr, errmsg, err) {
                    // Manejar errores de la petición
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Ocurrió un error al procesar la solicitud',
                        timer: 3000
                    });
                    console.error('Error:', errmsg);
                }
            });
        });
    });
    </script>
<script>
    document.getElementById('agregarClienteBtn').addEventListener('click', function() {
        var nuevoClienteContainer = document.getElementById('nuevoClienteContainer');
        if (nuevoClienteContainer.style.display === "none" || nuevoClienteContainer.style.display === "") {
            nuevoClienteContainer.style.display = "block";
        } else {
            nuevoClienteContainer.style.display = "none";
        }
    });

    document.getElementById('guardarClienteBtn').addEventListener('click', function() {
        var formData = new FormData(document.getElementById('form-nuevo-inquilino'));
        fetch('{% url "inmobiliaria:crear_inquilino_ajax" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var newOption = new Option(data.nombre + ' ' + data.apellido + ' (DNI: ' + data.dni + ')', data.id, true, true);
                $('#id_inquilino').append(newOption).trigger('change');
                document.getElementById('nuevoClienteContainer').style.display = 'none';
                document.getElementById('form-nuevo-inquilino').reset();
                Swal.fire({
                    icon: 'success',
                    title: 'Éxito',
                    text: 'Cliente creado correctamente'
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al guardar el cliente: ' + JSON.stringify(data.errors)
                });
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al procesar la solicitud'
            });
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
<script>
    $('#inquilino').on('change', function() {
    const selectedInquilinoId = $(this).val();
    if (selectedInquilinoId) {
        $.ajax({
            url: '{% url "inmobiliaria:obtener_inquilino" 0 %}'.replace('0', selectedInquilinoId),
            type: 'GET',
            success: function(data) {
                if (data.success) {
                    // Aquí puedes actualizar los campos del modal con la información del inquilino seleccionado
                    $('#modalCliente').val(data.inquilino.id);
                    // Agrega más actualizaciones según lo necesites
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo obtener la información del inquilino.'
                    });
                }
            },
            error: function(xhr, status, error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error del servidor',
                    text: 'Ocurrió un error al obtener la información del inquilino.'
                });
            }
        });
    } else {
        // Restaura los campos del modal a su estado inicial
        $('#modalCliente').val('');
        // Agrega más restauraciones según lo necesites
    }
});
</script>
<script>
        $('#cancelarReservaBtn').on('click', function() {
        $('#modalConfirmarReserva').modal('hide');
        // Enfocar la lista de propiedades
        $('#propiedadesTable').focus();
        // Opcionalmente, puedes resaltar la fila que estaba seleccionada
        if (selectedRowIndex !== -1) {
            const rows = document.querySelectorAll('#propiedadesTable tbody tr');
            rows[selectedRowIndex].focus();
        }
    });
</script>

<script>
    $('#cancelarReservaBtnA').on('click', function() {
    $('#modalAutenticacionVendedor').modal('hide');
    // Enfocar la lista de propiedades
    $('#propiedadesTable').focus();
    // Opcionalmente, puedes resaltar la fila que estaba seleccionada
    if (selectedRowIndex !== -1) {
        const rows = document.querySelectorAll('#propiedadesTable tbody tr');
        rows[selectedRowIndex].focus();
    }
});
document.addEventListener('DOMContentLoaded', function() {
    const precioTotalSuperior = document.getElementById('precioTotalSuperior');
    const precioTotalDisplay = document.getElementById('precio_total_display');
    const precioTotalInput = document.getElementById('precio_total');
    const editarPrecioBtn = document.getElementById('editar_precio_btn');
    const guardarPrecioBtn = document.getElementById('guardar_precio_btn');
    const cancelarPrecioBtn = document.getElementById('cancelar_precio_btn');
    const modalPrecioTotalInput = document.getElementById('modalPrecioTotal');
    const confirmarReservaForm = document.getElementById('confirmar-reserva-form');

    function actualizarPreciosMostrados(precio) {
        precioTotalSuperior.textContent = precio;
        precioTotalDisplay.textContent = precio;
        precioTotalInput.value = precio;
        modalPrecioTotalInput.value = precio;  // Actualiza el campo oculto
    }

    editarPrecioBtn.addEventListener('click', function() {
        precioTotalDisplay.style.display = 'none';
        precioTotalInput.style.display = 'inline-block';
        editarPrecioBtn.style.display = 'none';
        guardarPrecioBtn.style.display = 'inline-block';
        cancelarPrecioBtn.style.display = 'inline-block';
        precioTotalInput.focus();
    });

    guardarPrecioBtn.addEventListener('click', function() {
        const nuevoPrecio = precioTotalInput.value;
        actualizarPreciosMostrados(nuevoPrecio);
        precioTotalDisplay.style.display = 'inline';
        precioTotalInput.style.display = 'none';
        guardarPrecioBtn.style.display = 'none';
        cancelarPrecioBtn.style.display = 'none';
        editarPrecioBtn.style.display = 'inline';
    });

    cancelarPrecioBtn.addEventListener('click', function() {
        actualizarPreciosMostrados(precioTotalDisplay.textContent);
        precioTotalDisplay.style.display = 'inline';
        precioTotalInput.style.display = 'none';
        guardarPrecioBtn.style.display = 'none';
        cancelarPrecioBtn.style.display = 'none';
        editarPrecioBtn.style.display = 'inline';
    });

    // Añadir este evento al formulario de confirmación de reserva
    confirmarReservaForm.addEventListener('submit', function(event) {
        // Asegurarse de que el precio total se actualice antes de enviar el formulario
        const precioFinal = precioTotalInput.style.display === 'none' ? precioTotalDisplay.textContent : precioTotalInput.value;
        modalPrecioTotalInput.value = precioFinal;
    });
});
document.addEventListener('DOMContentLoaded', function() {
    const vendedorInput = document.getElementById('vendedor_id');
    const vendedorNombre = document.getElementById('vendedor_nombre');

    if (vendedorInput) {
        vendedorInput.addEventListener('change', function() {
            const vendedorId = this.value;
            if (vendedorId) {
                fetch(`${obtenerVendedorUrl}${vendedorId}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            vendedorNombre.textContent = data.vendedor.nombre_completo;
                        } else {
                            vendedorNombre.textContent = 'Vendedor no encontrado';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        vendedorNombre.textContent = 'Error al cargar el vendedor';
                    });
            } else {
                vendedorNombre.textContent = '';
            }
        });
    } else {
        console.error('El campo de vendedor no se encontró');
    }

});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
<script>
    const obtenerVendedorUrl = "{% url 'inmobiliaria:obtener_vendedor' 0 %}".slice(0, -1);
</script>


<!-- Modal para crear nuevo cliente -->

{% endblock %}

































