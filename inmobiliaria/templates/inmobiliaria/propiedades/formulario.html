{% extends 'inmobiliaria/base.html' %}
{% load bootstrap4 %}

{% block title %}{% if propiedad %}Editar{% else %}Nueva{% endif %} Propiedad{% endblock %}
{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">{% if propiedad %}Editar{% else %}Nueva{% endif %} Propiedad</h1>
    
    <!-- Formulario principal de la propiedad -->
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row">
            <!-- Información básica -->
            <div class="col-md-6">
                <h3>Información básica</h3>
              
                {% if propiedad %}
                {% bootstrap_field form.id layout='horizontal' readonly='readonly' %}
            {% else %}
                {% bootstrap_field form.id layout='horizontal' %}
            {% endif %}
                {% bootstrap_field form.direccion layout='horizontal' %}
                {% bootstrap_field form.ubicacion layout='horizontal' %}
                {% bootstrap_field form.tipo_inmueble layout='horizontal' %}
                {% bootstrap_field form.vista layout='horizontal' %}
                {% bootstrap_field form.piso layout='horizontal' %}
                {% bootstrap_field form.departamento layout='horizontal' %}
                {% bootstrap_field form.ambientes layout='horizontal' %}
                {% bootstrap_field form.valoracion layout='horizontal' %}
            </div>
            
            <!-- Información del propietario -->
            <div class="col-md-6">
                <h3>Propietario</h3>
                <div class="form-group">
                    <label for="id_propietario">Seleccionar Propietario:</label>
                    {{ form.propietario }}
                </div>
                
                <!-- <div class="form-check">
                    {{ form.nuevo_propietario }}
                    <label class="form-check-label" for="id_nuevo_propietario">Crear nuevo propietario<
                        /label>
                </div> -->
                
                <div id="nuevo-propietario-fields">
                    <!-- Botón para abrir el modal de crear propietario -->
                    <button id="abrir-modal-propietario-btn" type="button" class="btn btn-success" data-toggle="modal" data-target="#modal-propietario">Crear Nuevo Propietario</button>
                </div>
            </div>
            
  
        </div>
        
        <!-- Imágenes -->
        <div class="row mt-4">
            <div class="col-md-12">
                <h3>Imágenes</h3>
                <div class="form-group">
                    <label for="imagenes">Imágenes de la propiedad:</label>
                    {{ form.imagenes }}
                    {% if form.imagenes.help_text %}
                        <small class="form-text text-muted">{{ form.imagenes.help_text }}</small>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Características -->
        <div class="row mt-4">
            <div class="col-md-12">
                <h3>Características</h3>
                <div class="row">
                    {% for field in form %}
                        {% if field.field.widget.input_type == 'checkbox' and field.name not in 'habilitar_precio_diario,habilitar_precio_venta,habilitar_precio_alquiler' %}
                            <div class="col-md-3 mb-2">
                                <div class="form-check">
                                    {{ field }}
                                    <label class="form-check-label" for="{{ field.id_for_label }}">
                                        {{ field.label }}
                                    </label>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Descripción -->
        <div class="row mt-4">
            <div class="col-md-12">
                <h3>Descripción</h3>
                {% bootstrap_field form.descripcion %}
            </div>
        </div>
        
        <!-- Botón para guardar -->
        <div class="row mt-4">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </div>
    </form>

    <!-- Modal para crear nuevo propietario -->

<!-- Modal para agregar propietario -->
<div id="modal-propietario" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPropietarioLabel">Agregar Nuevo Propietario</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-nuevo-propietario" method="post">
                    {% csrf_token %}
                    {{ propietario_form.as_p }}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" id="guardar-propietario-btn" data-dismiss="modal" class="btn btn-primary">Guardar Propietario</button>
            </div>
        </div>
    </div>
</div>



</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<script>
    $(document).ready(function() {
        $('#guardar-propietario-btn').click(function() {
            var formData = $('#form-nuevo-propietario').serialize();
            $.ajax({
                url: '{% url "inmobiliaria:crear_propietario_ajax" %}',
                type: 'POST',
                data: formData,
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        // Agregar el nuevo propietario al select
                        var newOption = new Option(response.nombre + ' ' + response.apellido + ' (DNI: ' + response.dni + ')', response.id, true, true);
                        $('#id_propietario').append(newOption).trigger('change');
                        
                        // Cerrar el modal
                        $('#modal-propietario').modal('hide');
                        
                        // Limpiar el formulario
                        $('#form-nuevo-propietario')[0].reset();
                    } else {
                        // Mostrar errores
                       
                    }
                },
                error: function() {
                    alert('Error al procesar la solicitud');
                }
            });
        });
    });
</script>
<script>
    $(document).ready(function() {
        $('.select2-propietario').select2({
            ajax: {
                url: '{% url "inmobiliaria:buscar_propietarios" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term,
                        page: params.page
                    };
                },
                processResults: function (data, params) {
                    return {
                        results: data.results,
                    };
                },
                cache: true
            },
            minimumInputLength: 2,
            placeholder: 'Buscar propietario...',
            allowClear: true
        });
    });
    </script>
    <script>
        $(document).ready(function() {
            $('#guardar-propietario-btn').click(function() {
                var form = $('#form-nuevo-propietario');
    
                $.ajax({
                    type: form.attr('method'),
                    url: form.attr('action'),  // O la URL a la que enviarás la solicitud
                    data: form.serialize(),
                    success: function(response) {
                        if (response.success) {
                            alert(response.mensaje);  // Mensaje de éxito
                            $('#modal-propietario').modal('hide');  // Cierra el modal
                            form[0].reset();  // Limpia el formulario
                        } else {
                            alert('Error al guardar el propietario.');
                        }
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        alert('Error en la solicitud: ' + errorThrown);
                    }
                });
            });
        });
    </script>
{% endblock %}
