{% extends 'inmobiliaria/base.html' %}
{% load bootstrap4 %}

{% block title %}{% if propiedad %}Editar{% else %}Nueva{% endif %} Propiedad{% endblock %}
{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">{% if propiedad %}Editar{% else %}Nueva{% endif %} Propiedad</h1>
    
    <!-- Formulario principal de la propiedad -->
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row">
            <!-- Información básica -->
            <div class="col-md-6">
                <h3>Información básica</h3>
               
                {% bootstrap_field form.id layout='horizontal' %}
                

                {% bootstrap_field form.direccion layout='horizontal' %}
                {% bootstrap_field form.ubicacion layout='horizontal' %}
                {% bootstrap_field form.tipo_inmueble layout='horizontal' %}
                {% bootstrap_field form.vista layout='horizontal' %}
                {% bootstrap_field form.piso layout='horizontal' %}
                {% bootstrap_field form.departamento layout='horizontal' %}
                {% bootstrap_field form.ambientes layout='horizontal' %}
                {% bootstrap_field form.valoracion layout='horizontal' %}
            </div>
            
            <!-- Información del propietario -->
            <div class="col-md-6">
                <h3>Propietario</h3>
                <div class="form-group">
                    <label for="id_propietario">Seleccionar Propietario:</label>
                    {{ form.propietario }}
                </div>
                
                <!-- <div class="form-check">
                    {{ form.nuevo_propietario }}
                    <label class="form-check-label" for="id_nuevo_propietario">Crear nuevo propietario<
                        /label>
                </div> -->
                
                <div id="nuevo-propietario-fields">
                    <!-- Botón para abrir el modal de crear propietario -->
                    <button id="abrir-modal-propietario-btn" type="button" class="btn btn-success" data-toggle="modal" data-target="#modal-propietario">Crear Nuevo Propietario</button>
                </div>
            </div>
            
  
        </div>
        
        <!-- Imágenes -->
        <div class="row mt-4">
            <div class="col-md-12">
                <h3>Imágenes</h3>
                
                <!-- Input para subir imágenes -->
                <div class="form-group mb-3">
                    <label for="id_imagenes">Subir nuevas imágenes:</label>
                    <input type="file" id="id_imagenes" name="imagenes" multiple>
                    <small class="form-text text-muted">Seleccione una o más imágenes para la propiedad</small>
                </div>

                <!-- Vista previa de imágenes -->
                <div id="preview-container" class="d-flex flex-wrap gap-3 mb-3">
                    <!-- Las imágenes previsualizadas se mostrarán aquí -->
                </div>

                <!-- Contenedor de imágenes existentes -->
                <div id="imagenes-container" class="d-flex flex-wrap gap-3">
                    {% for imagen in imagenes %}
                    <div class="imagen-item" data-id="{{ imagen.id }}" draggable="true">
                        <div class="imagen-wrapper position-relative" style="width: 200px;">
                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 eliminar-imagen" 
                                    data-imagen-id="{{ imagen.id }}">
                                <i class="fas fa-times"></i>
                            </button>
                            <img src="{{ imagen.imagen.url }}" class="img-thumbnail" style="width: 100%; height: 150px; object-fit: cover;">
                            <small class="position-absolute bottom-0 start-0 m-1 bg-dark text-white px-2 rounded">
                                Orden: {{ imagen.orden }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Características -->
        <div class="row mt-4">
            <div class="col-md-12">
                <h3>Características</h3>
                <div class="row">
                    {% for field in form %}
                        {% if field.field.widget.input_type == 'checkbox' and field.name not in 'habilitar_precio_diario,habilitar_precio_venta,habilitar_precio_alquiler' %}
                            <div class="col-md-3 mb-2">
                                <div class="form-check">
                                    {{ field }}
                                    <label class="form-check-label" for="{{ field.id_for_label }}">
                                        {{ field.label }}
                                    </label>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Descripción -->
        <div class="row mt-4">
            <div class="col-md-12">
                <h3>Descripción</h3>
                {% bootstrap_field form.descripcion %}
            </div>
        </div>
        
        <!-- Botón para guardar -->
        <div class="row mt-4">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </div>
    </form>

    <!-- Modal para crear nuevo propietario -->

<!-- Modal para agregar propietario -->
<div id="modal-propietario" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPropietarioLabel">Agregar Nuevo Propietario</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-nuevo-propietario" method="post">
                    {% csrf_token %}
                    {{ propietario_form.as_p }}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" id="guardar-propietario-btn" data-dismiss="modal" class="btn btn-primary">Guardar Propietario</button>
            </div>
        </div>
    </div>
</div>




</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        const guardarPropietarioBtn = $('#guardar-propietario-btn');
        
        function resetearBoton() {
            guardarPropietarioBtn
                .prop('disabled', false)
                .html('Guardar Propietario')
                .removeClass('loading');
        }

        function mostrarBotonCargando() {
            guardarPropietarioBtn
                .prop('disabled', true)
                .html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...')
                .addClass('loading');
        }

        guardarPropietarioBtn.click(function(e) {
            e.preventDefault();
            
            // Verificar si el botón está en estado de carga
            if ($(this).hasClass('loading')) {
                return false;
            }

            // Limpiar errores previos
            $('.is-invalid').removeClass('is-invalid');
            $('.invalid-feedback').remove();
            
            // Mostrar estado de carga
            mostrarBotonCargando();
            
            var formData = $('#form-nuevo-propietario').serialize();
            
            $.ajax({
                url: '{% url "inmobiliaria:crear_propietario_ajax" %}',
                type: 'POST',
                data: formData,
                dataType: 'json'
            })
            .done(function(response) {
                console.log(response); // Verificar la respuesta del servidor
                if (response.success) {
                    // Crear nueva opción para el select
                    var newOption = new Option(
                        response.propietario_nombre,
                        response.propietario_id,
                        true,
                        true
                    );
                    $('#id_propietario').append(newOption).trigger('change');
                    
                    // Limpiar formulario y cerrar modal
                    $('#form-nuevo-propietario')[0].reset();
                    $('#modal-propietario').modal('hide');
                    
                    // Mostrar mensaje de éxito
                    alert('Propietario creado exitosamente');
                } else {
                    // Mostrar errores en los campos
                    if (response.errors) {
                        Object.keys(response.errors).forEach(function(fieldName) {
                            const field = $('#id_' + fieldName);
                            field.addClass('is-invalid');
                            
                            const errorDiv = $('<div>')
                                .addClass('invalid-feedback d-block')
                                .text(response.errors[fieldName].join(', '));
                            field.after(errorDiv);
                        });
                        
                        alert('Por favor, complete todos los campos requeridos');
                    } else {
                        alert(response.error || 'Error al crear el propietario');
                    }
                }
            })
            .fail(function(xhr, status, error) {
                alert('Error en la solicitud: ' + error);
            })
            .always(function() {
                // Siempre restaurar el botón, sin importar el resultado
                resetearBoton();
            });
        });

        // Limpiar validaciones al cerrar el modal
        $('#modal-propietario').on('hidden.bs.modal', function () {
            $('#form-nuevo-propietario')[0].reset();
            $('.is-invalid').removeClass('is-invalid');
            $('.invalid-feedback').remove();
            resetearBoton();
        });

        // Prevenir múltiples envíos
        $('#form-nuevo-propietario').on('submit', function(e) {
            e.preventDefault();
            if (!guardarPropietarioBtn.hasClass('loading')) {
                guardarPropietarioBtn.click();
            }
        });
    });
</script>
<script>
    $(document).ready(function() {
        $('.select2-propietario').select2({
            ajax: {
                url: '{% url "inmobiliaria:buscar_propietarios" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term,
                        page: params.page
                    };
                },
                processResults: function (data, params) {
                    return {
                        results: data.results,
                    };
                },
                cache: true
            },
            minimumInputLength: 2,
            placeholder: 'Buscar propietario...',
            allowClear: true
        });
    });
    </script>
    <script>
        $(document).ready(function() {
            $('#guardar-propietario-btn').click(function() {
                var form = $('#form-nuevo-propietario');
    
                $.ajax({
                    type: form.attr('method'),
                    url: form.attr('action'),  // O la URL a la que enviarás la solicitud
                    data: form.serialize(),
                    success: function(response) {
                        if (response.success) {
                            alert(response.mensaje);  // Mensaje de éxito
                            $('#modal-propietario').modal('hide');  // Cierra el modal
                            form[0].reset();  // Limpia el formulario
                        } else {
                            alert(response.mensaje);  // Mensaje de éxito
                            $('#modal-propietario').modal('hide');  // Cierra el modal
                            form[0].reset();  
                        }
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        alert('Error en la solicitud: ' + errorThrown);
                    }
                });
            });
        });
    </script>

<!-- Agregar estos estilos -->
<style>
.imagen-item {
    cursor: move;
    transition: transform 0.2s;
    margin: 10px;
}

.imagen-item:hover {
    transform: scale(1.05);
}

.imagen-item.dragging {
    opacity: 0.5;
}

.imagen-wrapper {
    border: 2px solid transparent;
    transition: border-color 0.3s;
    position: relative;
    width: 200px;
    height: 200px;
}

.imagen-wrapper:hover {
    border-color: #007bff;
}

.imagen-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.eliminar-imagen {
    position: absolute;
    top: 5px;
    right: 5px;
    z-index: 10;
}
</style>

<!-- Agregar este JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('imagenes-container');

    container.addEventListener('dragstart', e => {
        if (e.target.classList.contains('imagen-item')) {
            e.target.classList.add('dragging');
        }
    });

    container.addEventListener('dragend', e => {
        if (e.target.classList.contains('imagen-item')) {
            e.target.classList.remove('dragging');
            updateImageOrder();
        }
    });

    container.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientY);
        const draggable = document.querySelector('.dragging');
        if (afterElement == null) {
            container.appendChild(draggable);
        } else {
            container.insertBefore(draggable, afterElement);
        }
    });

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.imagen-item:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;

            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updateImageOrder() {
        const items = container.querySelectorAll('.imagen-item');
        const orderData = Array.from(items).map((item, index) => ({
            id: item.dataset.id,
            orden: index + 1
        }));

        // Enviar nuevo orden al servidor
        fetch('{% url "inmobiliaria:actualizar_orden_imagenes" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ imagenes: orderData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar números de orden mostrados
                items.forEach((item, index) => {
                    item.querySelector('small').textContent = `Orden: ${index + 1}`;
                });
            }
        });
    }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const inputImagenes = document.querySelector('#id_imagenes');
    const previewContainer = document.querySelector('#preview-container');
    let selectedFiles = [];

    inputImagenes.addEventListener('change', function(e) {
        selectedFiles = selectedFiles.concat(Array.from(this.files));

        previewContainer.innerHTML = '';

        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'imagen-item';
                div.innerHTML = `
                    <div class="imagen-wrapper position-relative">
                        <img src="${e.target.result}" class="img-thumbnail">
                        <small class="position-absolute bottom-0 start-0 m-1 bg-dark text-white px-2 rounded">
                            Nueva
                        </small>
                    </div>
                `;
                previewContainer.appendChild(div);
            }
            
            reader.readAsDataURL(file);
        });
    });
});
</script>
{% endblock %}
